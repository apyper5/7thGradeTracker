<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Franklin 7th Grade Tracker</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script>
        const SHEET_ID = '1c2morY1tLIv2pzyE0yWAMZKOq3Bt-myK9Z5f2ydsNPY';
        const CLIENT_ID = '326589757916-ce3tt4ji7hcdk1irgg0cv3f08mh1f7qj.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBO6nYreDN_rfTWSId2qY8EAJdcOE7kIgo';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const ADMIN_PASSWORD = '7foxes';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let currentView = 'login';
        let currentUser = null;
        let selectedStudent = null;
        let studentsList = [];
        let studentData = [];
        
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                renderApp();
            }
        }
        
        async function fetchSheet(sheetName) {
            const response = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SHEET_ID,
                range: sheetName,
            });
            return response.result.values || [];
        }
        
        async function updateCell(sheetName, range, value) {
            const response = await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SHEET_ID,
                range: \`\${sheetName}!\${range}\`,
                valueInputOption: 'RAW',
                resource: { values: [[value]] }
            });
            return response.result;
        }
        
        function renderApp() {
            const root = document.getElementById('root');
            
            if (currentView === 'login') {
                root.innerHTML = \`
                    <div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
                        <div class="max-w-4xl mx-auto">
                            <div class="text-center mb-12">
                                <h1 class="text-4xl font-bold text-gray-800 mb-2">Franklin 7th Grade Tracker</h1>
                                <p class="text-gray-600">Student Progress Tracking System</p>
                            </div>
                            
                            <div id="error-message"></div>
                            
                            <div class="grid md:grid-cols-2 gap-8">
                                <div class="bg-white rounded-lg shadow-lg p-8">
                                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Teacher Login</h2>
                                    <input type="password" id="admin-password" placeholder="Enter admin password" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                    <button onclick="handleTeacherLogin()" 
                                        class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">
                                        Sign in with Google
                                    </button>
                                    <p class="text-xs text-gray-500 mt-2">You'll be prompted to sign in with your Google account</p>
                                </div>
                                
                                <div class="bg-white rounded-lg shadow-lg p-8">
                                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Student/Parent Login</h2>
                                    <input type="text" id="student-code" placeholder="Enter access code" 
                                        class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <button onclick="handleStudentLogin()" 
                                        class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">
                                        View Progress
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                \`;
            } else if (currentView === 'admin') {
                renderAdminView();
            } else if (currentView === 'student') {
                renderStudentView();
            }
        }
        
        function handleTeacherLogin() {
            const password = document.getElementById('admin-password').value;
            if (password !== ADMIN_PASSWORD) {
                showError('Incorrect password');
                return;
            }
            
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showError('Authorization failed');
                    return;
                }
                currentView = 'admin';
                renderApp();
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function handleStudentLogin() {
            const code = document.getElementById('student-code').value.toUpperCase();
            try {
                const url = \`https://sheets.googleapis.com/v4/spreadsheets/\${SHEET_ID}/values/Students?key=\${API_KEY}\`;
                const response = await fetch(url);
                const data = await response.json();
                const students = data.values;
                
                const studentRow = students.slice(1).find(row => row[2] === code);
                if (studentRow) {
                    currentUser = { id: studentRow[0], name: studentRow[1], code: studentRow[2] };
                    currentView = 'student';
                    renderApp();
                } else {
                    showError('Invalid access code');
                }
            } catch (err) {
                showError('Failed to connect');
            }
        }
        
        async function renderAdminView() {
            const root = document.getElementById('root');
            root.innerHTML = \`
                <div class="min-h-screen bg-gray-50 p-8">
                    <div class="max-w-7xl mx-auto">
                        <div class="flex justify-between items-center mb-8">
                            <h1 class="text-3xl font-bold text-gray-800">Teacher Admin Panel</h1>
                            <button onclick="handleLogout()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Logout</button>
                        </div>
                        <div id="save-status" class="mb-4"></div>
                        <div class="bg-white rounded-lg shadow p-6 mb-8">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Select Student:</label>
                            <select id="student-select" onchange="handleStudentChange()" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div id="admin-content"></div>
                    </div>
                </div>
            \`;
            await loadStudentsList();
        }
        
        async function loadStudentsList() {
            try {
                const data = await fetchSheet('Students');
                studentsList = data.slice(1).map(row => ({ id: row[0], name: row[1] }));
                const select = document.getElementById('student-select');
                select.innerHTML = studentsList.map(s => \`<option value="\${s.id}">\${s.name}</option>\`).join('');
                selectedStudent = studentsList[0].id;
                await loadStudentRequirements();
            } catch (err) {
                showError('Failed to load students');
            }
        }
        
        async function handleStudentChange() {
            selectedStudent = document.getElementById('student-select').value;
            await loadStudentRequirements();
        }
        
        async function loadStudentRequirements() {
            try {
                const data = await fetchSheet(\`Student_\${selectedStudent}\`);
                studentData = data.slice(1).map((row, idx) => ({
                    rowNum: idx + 2,
                    subject: row[0] || '',
                    track: row[1] || '',
                    category: row[2] || '',
                    domain: row[3] || '',
                    requirement: row[4] || '',
                    completed: row[5] || '',
                    note: row[6] || '',
                    id: row[7] || ''
                }));
                renderStudentRequirements();
            } catch (err) {
                showError('Failed to load requirements');
            }
        }
        
        function renderStudentRequirements() {
            const grouped = {};
            studentData.forEach(item => {
                const key = \`\${item.subject}_\${item.track}\`;
                if (!grouped[key]) grouped[key] = { subject: item.subject, track: item.track, categories: {} };
                if (!grouped[key].categories[item.category]) grouped[key].categories[item.category] = {};
                if (!grouped[key].categories[item.category][item.domain]) grouped[key].categories[item.category][item.domain] = [];
                grouped[key].categories[item.category][item.domain].push(item);
            });
            
            const content = document.getElementById('admin-content');
            content.innerHTML = Object.entries(grouped).map(([key, data]) => \`
                <div class="bg-white rounded-lg shadow p-6 mb-8">
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">\${data.subject} - \${data.track}</h2>
                    \${Object.entries(data.categories).map(([cat, domains]) => \`
                        <div class="border-l-4 border-indigo-500 pl-4 mb-6">
                            <h3 class="text-lg font-bold text-gray-700 mb-3">\${cat}</h3>
                            \${Object.entries(domains).map(([dom, reqs]) => \`
                                <div class="mb-4">
                                    <h4 class="text-md font-semibold text-gray-600 mb-2">\${dom}</h4>
                                    <div class="space-y-2">
                                        \${reqs.map(req => \`
                                            <div class="flex items-center gap-3 bg-gray-50 p-3 rounded">
                                                <input type="text" value="\${req.completed}" 
                                                    onchange="handleUpdate(\${req.rowNum}, 'F', this.value)"
                                                    placeholder="X" class="w-16 px-2 py-1 border rounded text-center">
                                                <span class="flex-1 text-sm text-gray-700">\${req.requirement}</span>
                                                <input type="text" value="\${req.note}" 
                                                    onchange="handleUpdate(\${req.rowNum}, 'G', this.value)"
                                                    placeholder="Note" class="w-48 px-2 py-1 border rounded text-sm">
                                            </div>
                                        \`).join('')}
                                    </div>
                                </div>
                            \`).join('')}
                        </div>
                    \`).join('')}
                </div>
            \`).join('');
        }
        
        async function handleUpdate(rowNum, col, value) {
            try {
                await updateCell(\`Student_\${selectedStudent}\`, \`\${col}\${rowNum}\`, value);
                showSaveStatus('Saved!', 'success');
                const idx = studentData.findIndex(r => r.rowNum === rowNum);
                if (idx !== -1) {
                    if (col === 'F') studentData[idx].completed = value;
                    else studentData[idx].note = value;
                }
            } catch (err) {
                showSaveStatus('Save failed', 'error');
            }
        }
        
        function showSaveStatus(msg, type) {
            const div = document.getElementById('save-status');
            div.innerHTML = \`<div class="px-4 py-2 rounded-lg \${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">\${msg}</div>\`;
            setTimeout(() => div.innerHTML = '', 2000);
        }
        
        async function renderStudentView() {
            const root = document.getElementById('root');
            root.innerHTML = \`
                <div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-8">
                    <div class="max-w-4xl mx-auto">
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h1 class="text-3xl font-bold text-gray-800">\${currentUser.name}</h1>
                                <p class="text-gray-600">7th Grade Progress Tracker</p>
                            </div>
                            <button onclick="handleLogout()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Logout</button>
                        </div>
                        <div id="student-content">Loading...</div>
                    </div>
                </div>
            \`;
            await loadStudentProgress();
        }
        
        async function loadStudentProgress() {
            try {
                const url = \`https://sheets.googleapis.com/v4/spreadsheets/\${SHEET_ID}/values/Student_\${currentUser.id}?key=\${API_KEY}\`;
                const response = await fetch(url);
                const data = await response.json();
                const rows = data.values.slice(1).map(row => ({
                    subject: row[0], completed: row[5], requirement: row[4], note: row[6]
                }));
                
                const subjects = {};
                rows.forEach(r => {
                    if (!subjects[r.subject]) subjects[r.subject] = { total: 0, completed: 0 };
                    subjects[r.subject].total++;
                    if (r.completed) subjects[r.subject].completed++;
                });
                
                const totalCompleted = rows.filter(r => r.completed).length;
                const totalReqs = rows.length;
                const overallPercent = Math.round((totalCompleted / totalReqs) * 100);
                
                const recentCompletions = rows.filter(r => r.completed).slice(-10).reverse();
                
                const content = document.getElementById('student-content');
                content.innerHTML = \`
                    <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                        <h2 class="text-2xl font-bold text-gray-800 mb-4">Overall Progress</h2>
                        <div class="w-full bg-gray-200 rounded-full h-8">
                            <div class="h-full bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm" style="width: \${overallPercent}%">
                                \${overallPercent > 10 ? overallPercent + '%' : ''}
                            </div>
                        </div>
                        <p class="text-center mt-3 text-gray-600">\${totalCompleted} of \${totalReqs} requirements completed</p>
                    </div>
                    
                    \${Object.entries(subjects).map(([subj, prog]) => {
                        const pct = Math.round((prog.completed / prog.total) * 100);
                        const color = subj === 'ELA' ? 'bg-blue-600' : 'bg-purple-600';
                        return \`
                            <div class="bg-white rounded-lg shadow-lg p-8 mb-8">
                                <h2 class="text-xl font-bold text-gray-800 mb-2">\${subj}</h2>
                                <div class="w-full bg-gray-200 rounded-full h-8">
                                    <div class="h-full \${color} rounded-full flex items-center justify-center text-white font-bold text-sm" style="width: \${pct}%">
                                        \${pct > 10 ? pct + '%' : ''}
                                    </div>
                                </div>
                                <p class="text-center mt-2 text-gray-600">\${prog.completed} of \${prog.total} completed</p>
                            </div>
                        \`;
                    }).join('')}
                    
                    <div class="bg-white rounded-lg shadow-lg p-8">
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Recent Completions</h2>
                        <div class="space-y-2">
                            \${recentCompletions.length > 0 ? recentCompletions.map(item => \`
                                <div class="flex items-start gap-2 text-sm">
                                    <span class="text-green-500">âœ“</span>
                                    <div>
                                        <span class="text-gray-700">\${item.requirement}</span>
                                        \${item.note ? \`<span class="text-gray-500 ml-2">(\${item.note})</span>\` : ''}
                                    </div>
                                </div>
                            \`).join('') : '<p class="text-gray-500 italic">No items completed yet</p>'}
                        </div>
                    </div>
                \`;
            } catch (err) {
                showError('Failed to load progress');
            }
        }
        
        function handleLogout() {
            currentView = 'login';
            currentUser = null;
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            renderApp();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.innerHTML = \`<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">\${message}</div>\`;
            }
        }
        
        window.addEventListener('load', () => {
            gapiLoaded();
            gisLoaded();
        });
    </script>
</body>
</html>

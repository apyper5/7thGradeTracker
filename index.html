<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Franklin 7th Grade Tracker</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root">
        <div style="min-height: 100vh; background: linear-gradient(to bottom right, #eff6ff, #e0e7ff); padding: 2rem;">
            <div style="max-width: 64rem; margin: 0 auto; text-align: center; padding: 3rem 0;">
                <h1 style="font-size: 2.5rem; font-weight: bold; color: #1f2937; margin-bottom: 2rem;">Franklin 7th Grade Tracker</h1>
                <p style="color: #4b5563; margin-bottom: 3rem;">Loading OAuth system...</p>
                <div style="display: inline-block; width: 3rem; height: 3rem; border: 4px solid #e5e7eb; border-top-color: #6366f1; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
    
    <script>
        const SHEET_ID = '1c2morY1tLIv2pzyE0yWAMZKOq3Bt-myK9Z5f2ydsNPY';
        const CLIENT_ID = '326589757916-ce3tt4ji7hcdk1irgg0cv3f08mh1f7qj.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBO6nYreDN_rfTWSId2qY8EAJdcOE7kIgo';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const ADMIN_PASSWORD = '7foxes';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let currentView = 'login';
        let currentUser = null;
        let isAuthorized = false;
        
        // Initialize GAPI
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            });
            gapiInited = true;
            maybeEnableButtons();
        }
        
        // Initialize GIS
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '', // Will be set later
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                renderApp();
            }
        }
        
        // Fetch data from Google Sheets
        async function fetchSheet(sheetName) {
            const response = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SHEET_ID,
                range: sheetName,
            });
            return response.result.values || [];
        }
        
        // Update cell in Google Sheets
        async function updateCell(sheetName, range, value) {
            const response = await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SHEET_ID,
                range: `${sheetName}!${range}`,
                valueInputOption: 'RAW',
                resource: { values: [[value]] }
            });
            return response.result;
        }
        
        // Render the app
        function renderApp() {
            const root = document.getElementById('root');
            
            if (currentView === 'login') {
                root.innerHTML = `
                    <div style="min-height: 100vh; background: linear-gradient(to bottom right, #eff6ff, #e0e7ff); padding: 2rem;">
                        <div style="max-width: 64rem; margin: 0 auto;">
                            <div style="text-align: center; margin-bottom: 3rem;">
                                <h1 style="font-size: 2.5rem; font-weight: bold; color: #1f2937; margin-bottom: 0.5rem;">Franklin 7th Grade Tracker</h1>
                                <p style="color: #4b5563;">Student Progress Tracking System</p>
                            </div>
                            
                            <div id="error-message"></div>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                                <!-- Teacher Login -->
                                <div style="background: white; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 2rem;">
                                    <h2 style="font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 1.5rem;">Teacher Login</h2>
                                    <input type="password" id="admin-password" placeholder="Enter admin password" 
                                        style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-bottom: 1rem;">
                                    <button onclick="handleTeacherLogin()" 
                                        style="width: 100%; background: #6366f1; color: white; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer;">
                                        Sign in with Google
                                    </button>
                                    <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">You'll be prompted to sign in with your Google account</p>
                                </div>
                                
                                <!-- Student Login -->
                                <div style="background: white; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); padding: 2rem;">
                                    <h2 style="font-size: 1.5rem; font-weight: bold; color: #1f2937; margin-bottom: 1.5rem;">Student/Parent Login</h2>
                                    <input type="text" id="student-code" placeholder="Enter access code" 
                                        style="width: 100%; padding: 0.75rem 1rem; border: 1px solid #d1d5db; border-radius: 0.5rem; margin-bottom: 1rem;">
                                    <button onclick="handleStudentLogin()" 
                                        style="width: 100%; background: #10b981; color: white; padding: 0.75rem; border-radius: 0.5rem; font-weight: 600; border: none; cursor: pointer;">
                                        View Progress
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (currentView === 'admin') {
                root.innerHTML = `
                    <div style="min-height: 100vh; background: #f9fafb; padding: 2rem;">
                        <div style="max-width: 80rem; margin: 0 auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                <h1 style="font-size: 1.875rem; font-weight: bold; color: #1f2937;">Teacher Admin Panel</h1>
                                <button onclick="handleLogout()" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border-radius: 0.5rem; border: none; cursor: pointer;">Logout</button>
                            </div>
                            <div id="admin-content" style="background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); padding: 1.5rem;">
                                <p>Loading students...</p>
                            </div>
                        </div>
                    </div>
                `;
                loadAdminData();
            } else if (currentView === 'student') {
                root.innerHTML = `
                    <div style="min-height: 100vh; background: linear-gradient(to bottom right, #ecfdf5, #dbeafe); padding: 2rem;">
                        <div style="max-width: 64rem; margin: 0 auto;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                                <div>
                                    <h1 style="font-size: 1.875rem; font-weight: bold; color: #1f2937;">${currentUser.name}</h1>
                                    <p style="color: #4b5563;">7th Grade Progress Tracker</p>
                                </div>
                                <button onclick="handleLogout()" style="padding: 0.5rem 1rem; background: #6b7280; color: white; border-radius: 0.5rem; border: none; cursor: pointer;">Logout</button>
                            </div>
                            <div id="student-content">
                                <p>Loading progress...</p>
                            </div>
                        </div>
                    </div>
                `;
                loadStudentData();
            }
        }
        
        // Handle teacher login
        function handleTeacherLogin() {
            const password = document.getElementById('admin-password').value;
            if (password !== ADMIN_PASSWORD) {
                showError('Incorrect password');
                return;
            }
            
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    showError('Authorization failed');
                    return;
                }
                isAuthorized = true;
                currentView = 'admin';
                renderApp();
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        // Handle student login
        async function handleStudentLogin() {
            const code = document.getElementById('student-code').value.toUpperCase();
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Students?key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                const students = data.values;
                
                const studentRow = students.slice(1).find(row => row[2] === code);
                if (studentRow) {
                    currentUser = {
                        id: studentRow[0],
                        name: studentRow[1],
                        code: studentRow[2]
                    };
                    currentView = 'student';
                    renderApp();
                } else {
                    showError('Invalid access code');
                }
            } catch (err) {
                showError('Failed to connect');
                console.error(err);
            }
        }
        
        // Load admin data
        async function loadAdminData() {
            try {
                const students = await fetchSheet('Students');
                const content = document.getElementById('admin-content');
                content.innerHTML = '<p>OAuth is working! Teacher can now edit and save changes.</p><p>Full admin interface will load here.</p>';
            } catch (err) {
                showError('Failed to load admin data');
                console.error(err);
            }
        }
        
        // Load student data
        async function loadStudentData() {
            try {
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Student_${currentUser.id}?key=${API_KEY}`;
                const response = await fetch(url);
                const data = await response.json();
                
                const content = document.getElementById('student-content');
                content.innerHTML = '<p>Student data loaded successfully!</p><p>Progress bars will appear here.</p>';
            } catch (err) {
                showError('Failed to load student data');
                console.error(err);
            }
        }
        
        // Handle logout
        function handleLogout() {
            currentView = 'login';
            currentUser = null;
            isAuthorized = false;
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            renderApp();
        }
        
        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.innerHTML = `
                    <div style="background: #fee2e2; border: 1px solid #fca5a5; color: #991b1b; padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        ${message}
                    </div>
                `;
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', () => {
            gapiLoaded();
            gisLoaded();
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Franklin 7th Grade Tracker</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root">
        <div style="padding: 2rem; text-align: center;">
            <h1 style="font-size: 2rem; margin-bottom: 1rem;">Loading...</h1>
            <p>If this message persists, check the browser console (F12) for errors</p>
        </div>
    </div>
    
    <script>
        console.log('Script starting...');
        
        const SHEET_ID = '1c2morY1tLIv2pzyE0yWAMZKOq3Bt-myK9Z5f2ydsNPY';
        const CLIENT_ID = '326589757916-ce3tt4ji7hcdk1irgg0cv3f08mh1f7qj.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBO6nYreDN_rfTWSId2qY8EAJdcOE7kIgo';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';
        const ADMIN_PASSWORD = '7foxes';
        
        let tokenClient;
        let gapiInited = false;
        let gisInited = false;
        let currentView = 'login';
        let currentUser = null;
        let selectedStudent = null;
        let studentsList = [];
        let studentData = [];
        let collapsedSections = {};
        let collapsedCategories = {};
        let collapsedDomains = {};
        let studentCollapsedSubjects = {};
        let studentCollapsedCategories = {};
        let studentCollapsedDomains = {};
        
        function gapiLoaded() {
            console.log('GAPI loaded');
            gapi.load('client', initializeGapiClient);
        }
        
        async function initializeGapiClient() {
            console.log('Initializing GAPI client');
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            });
            gapiInited = true;
            console.log('GAPI initialized');
            maybeEnableButtons();
        }
        
        function gisLoaded() {
            console.log('GIS loaded');
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: '',
            });
            gisInited = true;
            maybeEnableButtons();
        }
        
        function maybeEnableButtons() {
            console.log('Checking if ready...', gapiInited, gisInited);
            if (gapiInited && gisInited) {
                console.log('Ready! Rendering app...');
                renderApp();
            }
        }
        
        async function fetchSheet(sheetName) {
            const response = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SHEET_ID,
                range: sheetName,
            });
            return response.result.values || [];
        }
        
        async function updateCell(sheetName, range, value) {
            const response = await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SHEET_ID,
                range: sheetName + '!' + range,
                valueInputOption: 'RAW',
                resource: { values: [[value]] }
            });
            return response.result;
        }
        
        function renderApp() {
            console.log('Rendering app, view:', currentView);
            const root = document.getElementById('root');
            
            if (currentView === 'login') {
                root.innerHTML = '<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8"><div class="max-w-4xl mx-auto"><div class="text-center mb-12"><h1 class="text-4xl font-bold text-gray-800 mb-2">Franklin 7th Grade Tracker</h1><p class="text-gray-600">Student Progress Tracking System</p></div><div id="error-message"></div><div class="grid md:grid-cols-2 gap-8"><div class="bg-white rounded-lg shadow-lg p-8"><h2 class="text-2xl font-bold text-gray-800 mb-6">Teacher Login</h2><button onclick="handleTeacherLogin()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition">Sign in with Google</button><p class="text-xs text-gray-500 mt-2">You will be prompted to sign in with your Google account</p></div><div class="bg-white rounded-lg shadow-lg p-8"><h2 class="text-2xl font-bold text-gray-800 mb-6">Student/Parent Login</h2><input type="text" id="student-code" placeholder="Enter access code" class="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:outline-none focus:ring-2 focus:ring-green-500"><button onclick="handleStudentLogin()" class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition">View Progress</button></div></div></div></div>';
            } else if (currentView === 'admin') {
                renderAdminView();
            } else if (currentView === 'student') {
                renderStudentView();
            }
        }
        
        function handleTeacherLogin() {
            console.log('Teacher login clicked');
            
            tokenClient.callback = async (resp) => {
                console.log('OAuth callback received', resp);
                if (resp.error !== undefined) {
                    showError('Authorization failed');
                    return;
                }
                currentView = 'admin';
                renderApp();
            };
            
            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        async function handleStudentLogin() {
            console.log('Student login clicked');
            const code = document.getElementById('student-code').value.toUpperCase();
            try {
                const url = 'https://sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/Students?key=' + API_KEY;
                const response = await fetch(url);
                const data = await response.json();
                const students = data.values;
                
                const studentRow = students.slice(1).find(row => row[2] === code);
                if (studentRow) {
                    currentUser = { id: studentRow[0], name: studentRow[1], code: studentRow[2] };
                    currentView = 'student';
                    renderApp();
                } else {
                    showError('Invalid access code');
                }
            } catch (err) {
                console.error('Student login error:', err);
                showError('Failed to connect');
            }
        }
        
        async function renderAdminView() {
            console.log('Rendering admin view');
            const root = document.getElementById('root');
            root.innerHTML = '<div class="min-h-screen bg-gray-50 p-8"><div class="max-w-7xl mx-auto"><div class="flex justify-between items-center mb-8"><h1 class="text-3xl font-bold text-gray-800">Teacher Admin Panel</h1><button onclick="handleLogout()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Logout</button></div><div id="save-status" class="mb-4"></div><div class="bg-white rounded-lg shadow p-6 mb-4"><label class="block text-sm font-semibold text-gray-700 mb-2">Select Student:</label><select id="student-select" onchange="handleStudentChange()" class="w-full px-4 py-3 border border-gray-300 rounded-lg"><option value="">Loading...</option></select></div><div class="mb-4 flex gap-2"><button onclick="collapseAll()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">Collapse All</button><button onclick="expandAll()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">Expand All</button></div><div id="admin-content"><p>Loading requirements...</p></div></div></div>';
            await loadStudentsList();
        }
        
        async function loadStudentsList() {
            try {
                const data = await fetchSheet('Students');
                studentsList = data.slice(1).map(row => ({ id: row[0], name: row[1] }));
                const select = document.getElementById('student-select');
                select.innerHTML = studentsList.map(s => '<option value="' + s.id + '">' + s.name + '</option>').join('');
                selectedStudent = studentsList[0].id;
                await loadStudentRequirements();
            } catch (err) {
                console.error('Load students error:', err);
                showError('Failed to load students');
            }
        }
        
        async function handleStudentChange() {
            selectedStudent = document.getElementById('student-select').value;
            await loadStudentRequirements();
        }
        
        async function loadStudentRequirements() {
            try {
                const data = await fetchSheet('Student_' + selectedStudent);
                studentData = data.slice(1).map((row, idx) => ({
                    rowNum: idx + 2,
                    subject: row[0] || '',
                    track: row[1] || '',
                    category: row[2] || '',
                    domain: row[3] || '',
                    requirement: row[4] || '',
                    completed: row[5] || '',
                    note: row[6] || ''
                }));
                renderStudentRequirements();
            } catch (err) {
                console.error('Load requirements error:', err);
                showError('Failed to load requirements');
            }
        }
        
        function renderStudentRequirements() {
            // Sort studentData before grouping
            studentData.sort((a, b) => {
                // First by subject
                if (a.subject !== b.subject) return a.subject.localeCompare(b.subject);
                // Then by track
                if (a.track !== b.track) return a.track.localeCompare(b.track);
                // Then by category
                if (a.category !== b.category) return a.category.localeCompare(b.category);
                // Then by domain - extract letter if it starts with one (like "A. Integers")
                const aDomainLetter = a.domain.match(/^([A-Z]+)\./)?.[1] || '';
                const bDomainLetter = b.domain.match(/^([A-Z]+)\./)?.[1] || '';
                if (aDomainLetter && bDomainLetter && aDomainLetter !== bDomainLetter) {
                    return aDomainLetter.localeCompare(bDomainLetter);
                }
                // Finally by domain name
                return a.domain.localeCompare(b.domain);
            });
            
            const grouped = {};
            studentData.forEach(item => {
                const key = item.subject + '_' + item.track;
                if (!grouped[key]) grouped[key] = { subject: item.subject, track: item.track, categories: {} };
                if (!grouped[key].categories[item.category]) grouped[key].categories[item.category] = {};
                if (!grouped[key].categories[item.category][item.domain]) grouped[key].categories[item.category][item.domain] = [];
                grouped[key].categories[item.category][item.domain].push(item);
            });
            
            let html = '';
            for (const [key, data] of Object.entries(grouped)) {
                const sectionId = 'section_' + key.replace(/\s+/g, '_');
                const isCollapsed = collapsedSections[sectionId];
                
                html += '<div class="bg-white rounded-lg shadow p-6 mb-8">';
                html += '<div class="flex justify-between items-center cursor-pointer" onclick="toggleSection(\'' + sectionId + '\')">';
                html += '<h2 class="text-2xl font-bold text-gray-800">' + data.subject + ' - ' + data.track + '</h2>';
                html += '<span class="text-2xl text-gray-600">' + (isCollapsed ? '‚ñº' : '‚ñ≤') + '</span>';
                html += '</div>';
                html += '<div id="' + sectionId + '" style="display: ' + (isCollapsed ? 'none' : 'block') + '" class="mt-4">';
                
                for (const [cat, domains] of Object.entries(data.categories)) {
                    const catId = sectionId + '_cat_' + cat.replace(/\s+/g, '_').replace(/\./g, '_');
                    const isCatCollapsed = collapsedCategories[catId];
                    
                    html += '<div class="border-l-4 border-indigo-500 pl-4 mb-6">';
                    html += '<div class="flex justify-between items-center cursor-pointer" onclick="toggleCategory(\'' + catId + '\')">';
                    html += '<h3 class="text-lg font-bold text-gray-700">' + cat + '</h3>';
                    html += '<span class="text-lg text-gray-600">' + (isCatCollapsed ? '‚ñº' : '‚ñ≤') + '</span>';
                    html += '</div>';
                    html += '<div id="' + catId + '" style="display: ' + (isCatCollapsed ? 'none' : 'block') + '" class="mt-3">';
                    
                    for (const [dom, reqs] of Object.entries(domains)) {
                        const domId = catId + '_dom_' + dom.replace(/\s+/g, '_').replace(/\./g, '_');
                        const isDomCollapsed = collapsedDomains[domId];
                        
                        html += '<div class="mb-4">';
                        html += '<div class="flex justify-between items-center cursor-pointer" onclick="toggleDomain(\'' + domId + '\')">';
                        html += '<h4 class="text-md font-semibold text-gray-600">' + dom + '</h4>';
                        html += '<span class="text-sm text-gray-600">' + (isDomCollapsed ? '‚ñº' : '‚ñ≤') + '</span>';
                        html += '</div>';
                        html += '<div id="' + domId + '" style="display: ' + (isDomCollapsed ? 'none' : 'block') + '" class="space-y-2 mt-2">';
                        
                        for (const req of reqs) {
                            html += '<div class="flex items-center gap-3 bg-gray-50 p-3 rounded">';
                            html += '<input type="text" value="' + req.completed + '" onchange="handleUpdate(' + req.rowNum + ', \'F\', this.value)" placeholder="X" class="w-16 px-2 py-1 border rounded text-center">';
                            html += '<span class="flex-1 text-sm text-gray-700">' + req.requirement + '</span>';
                            html += '<input type="text" value="' + req.note + '" onchange="handleUpdate(' + req.rowNum + ', \'G\', this.value)" placeholder="Note" class="w-48 px-2 py-1 border rounded text-sm">';
                            html += '</div>';
                        }
                        
                        html += '</div></div>';
                    }
                    
                    html += '</div></div>';
                }
                
                html += '</div></div>';
            }
            
            document.getElementById('admin-content').innerHTML = html;
        }
        
        function toggleSection(sectionId) {
            collapsedSections[sectionId] = !collapsedSections[sectionId];
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = collapsedSections[sectionId] ? 'none' : 'block';
            }
            renderStudentRequirements();
        }
        
        function toggleCategory(catId) {
            collapsedCategories[catId] = !collapsedCategories[catId];
            const cat = document.getElementById(catId);
            if (cat) {
                cat.style.display = collapsedCategories[catId] ? 'none' : 'block';
            }
            renderStudentRequirements();
        }
        
        function toggleDomain(domId) {
            collapsedDomains[domId] = !collapsedDomains[domId];
            const dom = document.getElementById(domId);
            if (dom) {
                dom.style.display = collapsedDomains[domId] ? 'none' : 'block';
            }
            renderStudentRequirements();
        }
        
        function collapseAll() {
            const sections = document.querySelectorAll('[id^="section_"]');
            sections.forEach(s => {
                collapsedSections[s.id] = true;
            });
            renderStudentRequirements();
        }
        
        function expandAll() {
            collapsedSections = {};
            collapsedCategories = {};
            collapsedDomains = {};
            renderStudentRequirements();
        }
        
        async function handleUpdate(rowNum, col, value) {
            try {
                await updateCell('Student_' + selectedStudent, col + rowNum, value);
                showSaveStatus('Saved!', 'success');
                const idx = studentData.findIndex(r => r.rowNum === rowNum);
                if (idx !== -1) {
                    if (col === 'F') studentData[idx].completed = value;
                    else studentData[idx].note = value;
                }
            } catch (err) {
                console.error('Update error:', err);
                showSaveStatus('Save failed', 'error');
            }
        }
        
        function showSaveStatus(msg, type) {
            const div = document.getElementById('save-status');
            if (div) {
                div.innerHTML = '<div class="px-4 py-2 rounded-lg ' + (type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800') + '">' + msg + '</div>';
                setTimeout(() => div.innerHTML = '', 2000);
            }
        }
        
        async function renderStudentView() {
            const root = document.getElementById('root');
            root.innerHTML = '<div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-50 p-8"><div class="max-w-5xl mx-auto"><div class="flex justify-between items-center mb-8"><div><h1 class="text-3xl font-bold text-gray-800">' + currentUser.name + '</h1><p class="text-gray-600">7th Grade Requirements</p></div><button onclick="handleLogout()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Logout</button></div><div class="mb-4 flex gap-2"><button onclick="collapseAllStudent()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">Collapse All</button><button onclick="expandAllStudent()" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 text-sm">Expand All</button></div><div id="student-content">Loading...</div></div></div>';
            await loadStudentProgress();
        }
        
        async function loadStudentProgress() {
            try {
                // Get student's track selections
                const studentsUrl = 'https://sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/Students?key=' + API_KEY;
                const studentsResponse = await fetch(studentsUrl);
                const studentsData = await studentsResponse.json();
                const studentRow = studentsData.values.slice(1).find(row => row[0] === currentUser.id);
                
                const tracks = {
                    ELA: studentRow[3] || '',
                    Math: studentRow[4] || '',
                    Science: studentRow[5] || '',
                    Utah_History: studentRow[6] || '',
                    Arts: studentRow[7] || ''
                };
                
                // Get student's progress data
                const url = 'https://sheets.googleapis.com/v4/spreadsheets/' + SHEET_ID + '/values/Student_' + currentUser.id + '?key=' + API_KEY;
                const response = await fetch(url);
                const data = await response.json();
                const rows = data.values.slice(1).map(row => ({
                    subject: row[0],
                    track: row[1],
                    category: row[2],
                    domain: row[3],
                    requirement: row[4],
                    completed: row[5],
                    note: row[6]
                }));
                
                // Sort rows before processing
                rows.sort((a, b) => {
                    if (a.subject !== b.subject) return a.subject.localeCompare(b.subject);
                    if (a.track !== b.track) return a.track.localeCompare(b.track);
                    if (a.category !== b.category) return a.category.localeCompare(b.category);
                    const aDomainLetter = a.domain.match(/^([A-Z]+)\./)?.[1] || '';
                    const bDomainLetter = b.domain.match(/^([A-Z]+)\./)?.[1] || '';
                    if (aDomainLetter && bDomainLetter && aDomainLetter !== bDomainLetter) {
                        return aDomainLetter.localeCompare(bDomainLetter);
                    }
                    return a.domain.localeCompare(b.domain);
                });
                
                // Group by subject
                const bySubject = {};
                rows.forEach(r => {
                    if (!bySubject[r.subject]) bySubject[r.subject] = [];
                    bySubject[r.subject].push(r);
                });
                
                // Calculate overall progress
                const totalCompleted = rows.filter(r => r.completed).length;
                const totalReqs = rows.length;
                const overallPercent = Math.round((totalCompleted / totalReqs) * 100);
                
                // GAMIFICATION: Calculate XP and Level
                const xp = totalCompleted * 10;
                const level = Math.floor(xp / 100) + 1;
                const xpInCurrentLevel = xp % 100;
                const xpToNextLevel = 100;
                const levelPercent = Math.round((xpInCurrentLevel / xpToNextLevel) * 100);
                
                const levelTitles = {
                    1: 'Beginner Scholar',
                    2: 'Scholar',
                    3: 'Dedicated Student',
                    4: 'Apprentice',
                    5: 'Skilled Learner',
                    6: 'Advanced Student',
                    7: 'Expert',
                    8: 'Master Student',
                    9: 'Elite Scholar',
                    10: 'Champion'
                };
                const levelTitle = levelTitles[Math.min(level, 10)] || 'Champion';
                
                // GAMIFICATION: Check achievements
                const achievements = [
                    { id: 'first_step', name: 'First Step', desc: 'Complete your first requirement', icon: 'üéØ', unlocked: totalCompleted >= 1 },
                    { id: 'getting_started', name: 'Getting Started', desc: 'Complete 10 requirements', icon: 'üî•', unlocked: totalCompleted >= 10 },
                    { id: 'halfway', name: 'Half Way There', desc: 'Reach 50% completion', icon: '‚≠ê', unlocked: overallPercent >= 50 },
                    { id: 'almost_done', name: 'Almost Done', desc: 'Reach 75% completion', icon: 'üèÜ', unlocked: overallPercent >= 75 },
                    { id: 'champion', name: '7th Grade Champion', desc: 'Complete 100%!', icon: 'üëë', unlocked: overallPercent >= 100 }
                ];
                
                const unlockedCount = achievements.filter(a => a.unlocked).length;
                
                // Start building HTML
                let html = '';
                
                // XP & Level Section
                html += '<div class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg shadow-lg p-6 mb-6 text-white">';
                html += '<div class="flex justify-between items-center mb-3">';
                html += '<div><h2 class="text-2xl font-bold">Level ' + level + ' - ' + levelTitle + '</h2>';
                html += '<p class="text-purple-100 text-sm">' + xp + ' XP earned ‚Ä¢ ' + (xpToNextLevel - xpInCurrentLevel) + ' XP to next level</p></div>';
                html += '<div class="text-4xl">üéì</div></div>';
                html += '<div class="w-full bg-purple-700 rounded-full h-4"><div class="h-full bg-yellow-400 rounded-full transition-all duration-500" style="width: ' + levelPercent + '%"></div></div>';
                html += '</div>';
                
                // Achievements Section
                html += '<div class="bg-white rounded-lg shadow-lg p-6 mb-6">';
                html += '<h2 class="text-xl font-bold text-gray-800 mb-4">Achievements (' + unlockedCount + '/' + achievements.length + ')</h2>';
                html += '<div class="grid grid-cols-2 md:grid-cols-5 gap-4">';
                achievements.forEach(ach => {
                    const unlockClass = ach.unlocked ? 'bg-gradient-to-br from-yellow-100 to-yellow-200 border-yellow-400' : 'bg-gray-100 border-gray-300 opacity-50';
                    html += '<div class="border-2 ' + unlockClass + ' rounded-lg p-4 text-center">';
                    html += '<div class="text-4xl mb-2">' + ach.icon + '</div>';
                    html += '<div class="font-bold text-sm text-gray-800">' + ach.name + '</div>';
                    html += '<div class="text-xs text-gray-600 mt-1">' + ach.desc + '</div>';
                    if (ach.unlocked) {
                        html += '<div class="text-xs text-green-600 font-semibold mt-2">‚úì Unlocked</div>';
                    } else {
                        html += '<div class="text-xs text-gray-500 mt-2">üîí Locked</div>';
                    }
                    html += '</div>';
                });
                html += '</div></div>';
                
                // Overall Progress
                html += '<div class="bg-white rounded-lg shadow-lg p-8 mb-8"><h2 class="text-2xl font-bold text-gray-800 mb-4">Overall Progress</h2><div class="w-full bg-gray-200 rounded-full h-8 mb-2"><div class="h-full bg-indigo-600 rounded-full flex items-center justify-center text-white font-bold text-sm transition-all duration-500" style="width: ' + overallPercent + '%">' + (overallPercent > 10 ? overallPercent + '%' : '') + '</div></div><p class="text-center text-gray-600">' + totalCompleted + ' of ' + totalReqs + ' requirements completed</p></div>';
                
                // Display each subject (rest of the code stays the same)
                for (const [subject, items] of Object.entries(bySubject)) {
                    const subjectCompleted = items.filter(i => i.completed).length;
                    const subjectTotal = items.length;
                    const subjectPercent = Math.round((subjectCompleted / subjectTotal) * 100);
                    const trackName = items[0].track;
                    
                    const colors = {
                        'ELA': { bar: 'bg-blue-600', text: 'text-blue-800', bg: 'bg-blue-50' },
                        'Math': { bar: 'bg-purple-600', text: 'text-purple-800', bg: 'bg-purple-50' },
                        'Science': { bar: 'bg-green-600', text: 'text-green-800', bg: 'bg-green-50' },
                        'Utah History': { bar: 'bg-orange-600', text: 'text-orange-800', bg: 'bg-orange-50' },
                        'Arts': { bar: 'bg-pink-600', text: 'text-pink-800', bg: 'bg-pink-50' }
                    };
                    const color = colors[subject] || { bar: 'bg-gray-600', text: 'text-gray-800', bg: 'bg-gray-50' };
                    
                    const subjectId = 'student_subj_' + subject.replace(/\s+/g, '_');
                    const isSubjectCollapsed = studentCollapsedSubjects[subjectId];
                    
                    html += '<div class="bg-white rounded-lg shadow-lg p-8 mb-8">';
                    html += '<div class="cursor-pointer" onclick="toggleStudentSubject(\'' + subjectId + '\')">';
                    html += '<div class="flex justify-between items-center mb-4">';
                    html += '<h2 class="text-2xl font-bold text-gray-800">' + subject + ' - ' + trackName + ' Track</h2>';
                    html += '<span class="text-2xl text-gray-600">' + (isSubjectCollapsed ? '‚ñº' : '‚ñ≤') + '</span>';
                    html += '</div>';
                    html += '<div class="w-full bg-gray-200 rounded-full h-6 my-3"><div class="h-full ' + color.bar + ' rounded-full flex items-center justify-center text-white font-semibold text-xs transition-all duration-500" style="width: ' + subjectPercent + '%">' + (subjectPercent > 10 ? subjectPercent + '%' : '') + '</div></div>';
                    html += '<p class="text-sm ' + color.text + ' font-semibold">' + subjectCompleted + ' of ' + subjectTotal + ' completed</p>';
                    html += '</div>';
                    
                    html += '<div id="' + subjectId + '" style="display: ' + (isSubjectCollapsed ? 'none' : 'block') + '">';
                    
                    const byCategory = {};
                    items.forEach(item => {
                        if (!byCategory[item.category]) byCategory[item.category] = {};
                        if (!byCategory[item.category][item.domain]) byCategory[item.category][item.domain] = [];
                        byCategory[item.category][item.domain].push(item);
                    });
                    
                    for (const [category, domains] of Object.entries(byCategory)) {
                        const catId = subjectId + '_cat_' + category.replace(/\s+/g, '_').replace(/\./g, '_');
                        const isCatCollapsed = studentCollapsedCategories[catId];
                        
                        html += '<div class="mt-6 border-l-4 border-indigo-400 pl-4">';
                        html += '<div class="flex justify-between items-center cursor-pointer" onclick="toggleStudentCategory(\'' + catId + '\')">';
                        html += '<h3 class="text-lg font-bold text-gray-700">' + category + '</h3>';
                        html += '<span class="text-lg text-gray-600">' + (isCatCollapsed ? '‚ñº' : '‚ñ≤') + '</span>';
                        html += '</div>';
                        html += '<div id="' + catId + '" style="display: ' + (isCatCollapsed ? 'none' : 'block') + '" class="mt-3">';
                        
                        for (const [domain, reqs] of Object.entries(domains)) {
                            const domId = catId + '_dom_' + domain.replace(/\s+/g, '_').replace(/\./g, '_');
                            const isDomCollapsed = studentCollapsedDomains[domId];
                            
                            html += '<div class="mb-4">';
                            html += '<div class="flex justify-between items-center cursor-pointer" onclick="toggleStudentDomain(\'' + domId + '\')">';
                            html += '<h4 class="text-md font-semibold text-gray-600">' + domain + '</h4>';
                            html += '<span class="text-sm text-gray-600">' + (isDomCollapsed ? '‚ñº' : '‚ñ≤') + '</span>';
                            html += '</div>';
                            html += '<div id="' + domId + '" style="display: ' + (isDomCollapsed ? 'none' : 'block') + '">';
                            html += '<ul class="space-y-2 mt-2">';
                            
                            for (const req of reqs) {
                                const icon = req.completed ? '<span class="text-green-600 font-bold text-lg">‚úì</span>' : '<span class="text-gray-400 font-bold text-lg">‚òê</span>';
                                const textColor = req.completed ? 'text-gray-600' : 'text-gray-800';
                                const bgColor = req.completed ? color.bg : 'bg-white';
                                
                                html += '<li class="flex items-start gap-3 p-2 rounded ' + bgColor + '">';
                                html += icon;
                                html += '<span class="flex-1 ' + textColor + ' text-sm">' + req.requirement;
                                if (req.note) {
                                    html += ' <span class="text-gray-500 italic">(' + req.note + ')</span>';
                                }
                                html += '</span></li>';
                            }
                            
                            html += '</ul></div></div>';
                        }
                        
                        html += '</div></div>';
                    }
                    
                    html += '</div></div>';
                }
                
                document.getElementById('student-content').innerHTML = html;
            } catch (err) {
                console.error('Load progress error:', err);
                showError('Failed to load progress');
            }
        }
        
        function toggleStudentSubject(subjectId) {
            studentCollapsedSubjects[subjectId] = !studentCollapsedSubjects[subjectId];
            loadStudentProgress();
        }
        
        function toggleStudentCategory(catId) {
            studentCollapsedCategories[catId] = !studentCollapsedCategories[catId];
            loadStudentProgress();
        }
        
        function toggleStudentDomain(domId) {
            studentCollapsedDomains[domId] = !studentCollapsedDomains[domId];
            loadStudentProgress();
        }
        
        function collapseAllStudent() {
            const subjects = document.querySelectorAll('[id^="student_subj_"]');
            subjects.forEach(s => {
                if (!s.id.includes('_cat_') && !s.id.includes('_dom_')) {
                    studentCollapsedSubjects[s.id] = true;
                }
            });
            loadStudentProgress();
        }
        
        function expandAllStudent() {
            studentCollapsedSubjects = {};
            studentCollapsedCategories = {};
            studentCollapsedDomains = {};
            loadStudentProgress();
        }
        
        function handleLogout() {
            currentView = 'login';
            currentUser = null;
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            renderApp();
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.innerHTML = '<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6">' + message + '</div>';
            } else {
                alert(message);
            }
        }
        
        window.addEventListener('load', () => {
            console.log('Window loaded, starting initialization');
            gapiLoaded();
            gisLoaded();
        });
        
        console.log('Script loaded successfully');
    </script>
</body>
</html>
